# v7.36 CRITICAL FIX - PowerShell Runspace Scope Resolution

## Execution Summary
- **Version**: v7.36 (October 9, 2025 6:30 PM)
- **Status**: CRITICAL FIX for v7.35 scope failure
- **Previous Attempts**: v7.35 FAILED - module processing still returned empty hashtables

## Problem Discovered in v7.35 Logs

### Execution: 35861089-fa2f-4b1c-9827-00712c1cb99c (v7.35)
```
Lines 243-245: "‚úÖ Resources imported successfully: 59 items" ‚Üí "[JOB] returned NULL"
Lines 253-256: "‚úÖ Resources imported successfully: 17 items" ‚Üí "[JOB] returned NULL"  
Lines 328-331: "‚úÖ Resources imported successfully: 2 items" ‚Üí "[JOB] returned NULL"
Lines 480-483: "‚úÖ Resources imported successfully: 26 items" ‚Üí "[JOB] returned NULL"

Line 289, 348, 419, 516: "DEBUG: Cache Files Created: 0 files" (repeated 4 times)
```

**Result**: Same failure as v7.34! Import succeeds, module processing returns empty hashtables.

## Root Cause Analysis - v7.35 Scope Bug

### v7.35 Code (BROKEN):
```powershell
# Line 196-198: Create variable injection script
$ResourcesVarScript = "`$Resources = `$args[0]; `$PSScriptRoot = `$args[1]; ..."

# Line 200: Add TWO separate script blocks
[PowerShell]::Create()
    .AddScript($ResourcesVarScript)    # Script 1: Creates $Resources in scope A
    .AddArgument($Resources)           # Pass data
    .AddScript($ModuleData)            # Script 2: Executes in CHILD scope B (can't see scope A variables!)
```

### Why v7.35 Failed:
1. **First `.AddScript()`**: Creates `$Resources` variable in parent runspace scope
2. **Second `.AddScript()`**: Executes module code in NESTED CHILD scope
3. **Module code tries**: `$Resources | Where-Object ...`
4. **PowerShell sees**: `$Resources` is undefined in child scope ‚Üí empty results
5. **Result**: Hashtables return with 0 keys, no cache files created

### PowerShell Scope Behavior:
```powershell
# This creates NESTED scopes:
[PowerShell]::Create()
    .AddScript('$var = $args[0]')    # Scope Level 1
    .AddScript('Write-Host $var')    # Scope Level 2 (can't see Level 1 variables!)
```

## v7.36 Solution - Combined Script Block

### The Fix:
```powershell
# Lines 186-200 (v7.36):
# Create SINGLE script block with variable assignments AND module code
$CombinedScript = @"
# Assign variables from arguments
`$Resources = `$args[0]
`$PSScriptRoot = `$args[1]
`$Subscriptions = `$args[2]
`$InTag = `$args[3]
`$Retirements = `$args[4]
`$Task = `$args[5]
`$Unsupported = `$args[6]

# Execute module code in same scope
$ModuleData
"@

# Now use SINGLE AddScript() call
[PowerShell]::Create()
    .AddScript($CombinedScript)    # All code in ONE scope!
    .AddArgument($Resources)
    .AddArgument($PSScriptRoot)
    ... (etc)
```

### Why v7.36 Works:
1. **Variable assignment and module code in SAME script string**
2. **Single `.AddScript()` call** - no nested scopes
3. **Module code executes in SAME scope** where `$Resources` was defined
4. **Module code sees**: `$Resources | Where-Object ...` works!
5. **Result**: Hashtables populated with data, cache files created

## Expected v7.36 Behavior

### Success Indicators:
```
Line ~243: "‚úÖ Resources imported successfully: 59 items"
Line ~244: "[JOB] Module 'AzureAI' processed: 12 items"
Line ~245: "[JOB] Module 'SearchServices' processed: 8 items"
Line ~246: "[JOB] Hashtable complete with 14 keys"

Line ~289: "DEBUG: Cache Files Created: 16 files in /data/AzureResourceInventory/ReportCache"

Line ~536-538: Found AI.json cache file
Line ~557-558: Found Analytics.json cache file
Line ~569-570: Found APIs.json cache file
... (etc for all 16 modules)

Line ~750-768: Excel report with 16+ tabs (not just Advisor + Subscription)
```

### Report Structure:
- ‚úÖ AI tab (Azure AI, Search Services, Cognitive Services, etc.)
- ‚úÖ Analytics tab (Databricks, Event Hub, Synapse, etc.)
- ‚úÖ APIs tab (Advisor Score, Managed IDs, Support Tickets, etc.)
- ‚úÖ Compute tab (VMs, VMSS, AVD, etc.)
- ‚úÖ Container tab (AKS, Container Apps, ACR, etc.)
- ‚úÖ Database tab (CosmosDB, SQL, MySQL, PostgreSQL, Redis, etc.)
- ‚úÖ Hybrid tab (ARC Servers)
- ‚úÖ Integration tab (APIM, Service Bus)
- ‚úÖ IoT tab (IoT Hubs)
- ‚úÖ Management tab (Automation Accounts, Backup, Recovery Vault)
- ‚úÖ Monitoring tab (App Insights, Workspaces)
- ‚úÖ Network_1 tab (VNet, Subnets, NSG, Route Tables, etc.)
- ‚úÖ Network_2 tab (App Gateway, Firewall, Load Balancer, etc.)
- ‚úÖ Security tab (Key Vault)
- ‚úÖ Storage tab (Storage Accounts, NetApp)
- ‚úÖ Web tab (App Service, App Service Plan)
- ‚úÖ Advisor tab (1401 advisories)
- ‚úÖ Subscription tab

## Deployment Steps

### 1. Build v7.36 Docker Image
```powershell
docker build --no-cache -t rkazureinventory.azurecr.io/azure-resource-inventory:v7.36 .
```

**Expected**: 
- Build time: ~270-280 seconds
- 16/16 stages completed
- New image with v7.36 Start-ARIProcessJob.ps1

### 2. Push to Azure Container Registry
```powershell
docker push rkazureinventory.azurecr.io/azure-resource-inventory:v7.36
```

**Expected**:
- 13 layers total
- New layers contain v7.36 fix
- Digest: sha256:XXXXXXXX

### 3. Verify Deployment
```powershell
az containerapp show --name azure-resource-inventory --resource-group rg-rkibbe-2470 --query "properties.template.containers[0].image" -o tsv
```

**Expected Output**: `rkazureinventory.azurecr.io/azure-resource-inventory:v7.36`

### 4. Test Execution
1. Navigate to: https://azure-resource-inventory.ambitiousbeach-c62b6a92.eastus.azurecontainerapps.io/cli-device-login
2. Complete device login authentication
3. Wait ~1.5-2 minutes for execution
4. Monitor container logs for success indicators

## Testing Validation Points

### Critical Log Lines to Check:
```
Line ~200: "‚öôÔ∏è Parallel job limit set to 4 (v7.33-v7.35: reduced batches + per-job filtering)"
Line ~243: Should show "[JOB] Module 'X' processed: Y items" (NOT "returned NULL")
Line ~289: Should show "Cache Files Created: 16 files" (NOT "0 files")
Line ~536-713: Should find cache files for all 16 modules
```

### Failure Indicators (should NOT appear):
```
‚ùå "[JOB] returned NULL"
‚ùå "Cache Files Created: 0 files"
‚ùå "WARNING: No cache file found for module folder: X"
‚ùå "Module 'X': Resource count = 0" (when resources exist)
```

## Technical Explanation

### PowerShell Runspace Scoping Rules:
1. **Each `.AddScript()` call creates a new scope**
2. **Variables defined in parent scope are NOT visible in child scope by default**
3. **Solution**: Put all code in single script string before calling `.AddScript()`

### Why This Matters:
Module files contain code like:
```powershell
$Resources | Where-Object {$_.TYPE -eq 'Microsoft.KeyVault/vaults'}
```

This REQUIRES `$Resources` to exist in the SAME SCOPE. v7.35 created it in a parent scope, v7.36 creates it in the SAME scope as the module code.

## Success Criteria

### v7.36 Must Achieve:
1. ‚úÖ All jobs import resources successfully (Import-Clixml)
2. ‚úÖ All jobs process modules and populate hashtables
3. ‚úÖ 16 cache JSON files created in ReportCache directory
4. ‚úÖ Excel report has 16+ tabs (not just 2)
5. ‚úÖ Each tab contains actual resource data (not empty)
6. ‚úÖ Execution completes in ~1.5-2 minutes

### Comparison:
- **v7.34**: Import works ‚úÖ, module processing fails ‚ùå (0 cache files)
- **v7.35**: Import works ‚úÖ, module processing fails ‚ùå (0 cache files, scope bug)
- **v7.36**: Import works ‚úÖ, module processing SHOULD WORK ‚úÖ (16 cache files expected)

## Next Steps

1. **Build v7.36**: `docker build --no-cache ...`
2. **Push v7.36**: `docker push ...`
3. **Verify**: `az containerapp show ...`
4. **Test**: Trigger device login execution
5. **Validate**: Check logs for success indicators
6. **Download**: Get v7.36 Excel report
7. **Verify**: Count tabs (should be 16+, not 2)

If v7.36 succeeds:
- ‚úÖ Issue RESOLVED
- ‚úÖ Mark as stable version
- ‚úÖ Document as production-ready

If v7.36 fails:
- üîç Check if $CombinedScript is correctly formatted
- üîç Verify module files can access $Resources variable
- üîç May need alternative approach (modify module files directly)

---

**Date**: October 9, 2025  
**Time**: 6:30 PM EDT  
**Version**: v7.36  
**Status**: READY FOR BUILD & TEST
