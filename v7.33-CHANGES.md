# v7.33 - Per-Job Filtering + Reduced Batch Size

## üéØ Problem Being Solved
v7.32 execution showed ALL 16 jobs returning NULL because:
- Each job tried to import the SAME 87 MB XML file
- Import-Clixml crashes in job runspaces with files this large
- Reducing serialization depth (10‚Üí5) didn't help - file stayed 87 MB
- File size driven by breadth (1064 resources) not depth

## üöÄ Solution - Two-Pronged Approach

### 1. Per-Job Resource Filtering (Main Fix)
**BEFORE (v7.32):**
```
Parent Process: Serialize ALL 1064 resources ‚Üí 87 MB file
Job 1 (AI): Import 87 MB ‚Üí CRASH
Job 2 (Analytics): Import 87 MB ‚Üí CRASH
... (all 16 jobs crash)
```

**AFTER (v7.33):**
```
Parent Process: 
  - Keep resources in memory
  - For each job, filter by resource TYPE
  - Create per-job temp file with ONLY relevant resources

Job 1 (AI): Import ~50 AI resources ‚Üí 5 MB file ‚Üí ‚úÖ SUCCESS
Job 2 (Analytics): Import ~30 Analytics resources ‚Üí 3 MB file ‚Üí ‚úÖ SUCCESS
... (each job gets small, manageable file)
```

**Implementation:**
- Lines 63-71: Store all resources, don't serialize upfront
- Lines 90-126: Extract resource type from module file, filter, create per-job temp file
- Line 283: Pass job-specific `$TempJobFile` instead of global `$TempJsonFile`
- Lines 303-310: Cleanup all per-job temp files

### 2. Reduced Batch Size (Memory Optimization)
**BEFORE:** 8 jobs in parallel
**AFTER:** 4 jobs in parallel (line 31)

**Rationale:**
- Less memory pressure overall
- More RAM available per job
- Reduced file I/O contention
- Still processes all 16 jobs efficiently (4 batches of 4)

## üìä Expected Impact

### Memory Footprint:
- **v7.32:** 8 jobs √ó 87 MB = 696 MB total
- **v7.33:** 4 jobs √ó 10 MB avg = 40 MB total (94% reduction!)

### File Sizes (Estimated):
```
AI:          ~50 resources  ‚Üí  5 MB
Analytics:   ~30 resources  ‚Üí  3 MB
APIs:        ~20 resources  ‚Üí  2 MB
Compute:     ~150 resources ‚Üí 12 MB
Container:   ~80 resources  ‚Üí  8 MB
Database:    ~100 resources ‚Üí 10 MB
... etc (all under 15 MB)
```

### Execution Timeline:
```
Batch 1 (0-30s):  AI, Analytics, APIs, Compute
Batch 2 (30-60s): Container, Database, Hybrid, Integration
Batch 3 (60-90s): IoT, Management, Monitoring, Network_1
Batch 4 (90-120s): Network_2, Security, Storage, Web
```

## üîç Key Code Changes

**1. Resource filtering extraction:**
```powershell
# Read first module file to get TYPE filter
$FirstModuleContent = Get-Content -Path $ModuleFiles[0].FullName -Raw

# Extract: $AzureAI = $Resources | Where-Object {$_.TYPE -eq 'microsoft.cognitiveservices/accounts'}
if ($FirstModuleContent -match "TYPE -eq '([^']+)'") {
    $ResourceType = $matches[1]
    $FilteredResources = $AllResources | Where-Object { $_.TYPE -eq $ResourceType }
}
```

**2. Per-job temp file:**
```powershell
$TempJobFile = [System.IO.Path]::Combine([System.IO.Path]::GetTempPath(), 
    "ari_${ModuleName}_$(Get-Date -Format 'yyyyMMdd_HHmmss').xml")
$FilteredResources | Export-Clixml -Path $TempJobFile -Depth 5 -Force
```

**3. Job logging enhancement:**
```powershell
Write-Host "üì¶ [$ModuleName] Filtered to $FilteredCount resources" -ForegroundColor Cyan
```

## ‚úÖ Expected Success Indicators

When v7.33 runs successfully, you should see:
1. ‚úÖ `üì¶ [AI] Filtered to 50 resources` (each module shows filtered count)
2. ‚úÖ `[JOB] ‚úÖ Resources imported successfully: 50 items` (not NULL!)
3. ‚úÖ `Cache Files Created: 16 files` (not 0!)
4. ‚úÖ Excel reports with COMPLETE data from all resource types

## üö® What to Watch For

**If jobs still crash:**
- Check log for "Filtered to X resources" - is X still too high?
- Look at per-job file sizes in debug output
- Some resource types might have very large individual objects

**If filtering fails:**
- Log will show "Filtered to 1064 resources" (fallback - passing all)
- Means regex didn't match TYPE filter in module file
- Job will still attempt to import full dataset

## üìù Testing Checklist

- [ ] Build succeeds
- [ ] Container deploys to ACR/ACA
- [ ] Execution shows filtered resource counts per job
- [ ] Jobs return data (not NULL)
- [ ] 16 cache files created
- [ ] Excel reports contain data for all tabs
- [ ] No duplicate Advisor-only reports

## üéâ Why This Should Work

1. **Proven pattern:** Module files already filter by TYPE - we're just doing it earlier
2. **Memory-safe:** 4 jobs √ó 10 MB = 40 MB (well within limits)
3. **No architectural risk:** Filtering logic copied from existing module code
4. **Incremental improvement:** Can further optimize if specific job still fails
